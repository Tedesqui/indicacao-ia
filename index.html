<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registre um pedido e nos envie (Automatizada por IA)!!!</title>
    <style>
        :root {
            --primary-color: #007BFF;
            --primary-hover: #0056b3;
            --background-color: #f4f7f9;
            --form-background: #ffffff;
            --text-color: #333;
            --label-color: #555;
            --border-color: #ccc;
            --success-color: #28a745;
            --error-color: #dc3545;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow: hidden; 
        }
        video, canvas {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; z-index: -1;
            display: none; 
        }
        #initial-form-container {
            position: fixed;
            top: 10px; 
            left: 50%;
            transform: translateX(-50%); 
            background-color: var(--form-background);
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 650px;
            box-sizing: border-box;
            z-index: 10;
            display: flex; 
            flex-direction: column; 
        }
        #capture-ui {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 1rem 1rem 1.5rem 1rem; 
            background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0.6), transparent); 
            color: white;
            text-align: center;
            z-index: 5; 
            box-sizing: border-box;
            display: none; 
            flex-direction: column; 
            gap: 10px; 
        }
        #capture-ui #status-text { 
            color: white; 
            background-color: rgba(0,0,0,0.6);
            padding: 8px 15px;
            border-radius: 8px;
            margin-bottom: 5px; 
            font-size: 0.9em;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            display: none; 
        }
        #review-area {
            display: none; 
            width: 90%;
            max-width: 400px;
            margin: 5px auto 10px auto;
            text-align: left;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
        }
        #review-area label {
            font-weight: 600;
            font-size: 0.9em;
            color: white;
            margin-bottom: 5px;
            display: block;
        }
        #review-area textarea {
            width: 100%;
            box-sizing: border-box;
            background: #f9f9f9;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95em;
        }
        h1 { color: #000000; text-align: center; margin-top: 0; margin-bottom: 2rem; font-weight: 700; }
        .form-group { margin-bottom: 19px; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--label-color); }
        input[type="text"], input[type="tel"] {
            width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--border-color);
            border-radius: 8px; box-sizing: border-box; font-size: 1rem;
        }
        .submit-btn {
            background: linear-gradient(45deg, var(--primary-color), var(--primary-hover));
            color: white; padding: 1rem 1.5rem; border: none; border-radius: 8px;
            cursor: pointer; width: 100%; max-width: 400px; 
            font-size: 1.1rem; font-weight: 600;
            margin-left: auto; 
            margin-right: auto; 
        }
        .submit-btn:disabled { background: #aaa; cursor: not-allowed; }
        #form-result { margin-top: 1.5rem; padding: 1rem; border-radius: 8px; text-align: center; font-weight: 500; display: none; }
        #form-result.error { background-color: #fdecea; color: var(--error-color); display: block; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--form-background); padding: 2.5rem 3.5rem; border-radius: 12px; text-align: center; }
        .modal-content p { margin: 0; font-size: 1.2rem; font-weight: 600; color: var(--success-color); }
        #preview-img {
            max-width: 90%; max-height: 200px; 
            border-radius: 8px; margin-bottom: 10px;
            border: 2px solid white; display: none; 
            margin-left: auto; margin-right: auto;
            object-fit: contain; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>

    <div class="container" id="initial-form-container">
        <h1>Registre um Problema e envie para o Vereador</h1>
        <form id="initial-form">
            <div class="form-group">
                <label for="nome">Seu Nome Completo</label>
                <input type="text" id="nome" name="nome" required>
            </div>
            
            <div class="form-group">
                <label for="telefone">Telefone / WhatsApp</label>
                <input type="tel" id="telefone" name="telefone" required placeholder="(XX) XXXXX-XXXX">
            </div>
            
            <button type="button" class="submit-btn" id="start-camera-button">
                <span>‚ñ∂Ô∏è Iniciar C√¢mera e GPS</span>
            </button>
        </form>
        <div id="form-result"></div>
    </div>
    
    <div id="capture-ui">
        <img id="preview-img" alt="Pr√©-visualiza√ß√£o do problema" />

        <div id="status-text" style="display: none;"></div> 
        
        <div id="review-area">
            <label for="descricao_ia_review">Texto a ser enviado (gerado por IA):</label>
            <textarea id="descricao_ia_review" rows="6"></textarea>
        </div>
        
        <form id="indication-form">
            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">
            
            <input type="hidden" id="street_address" name="street_address">

            <input type="hidden" id="imagem_base64" name="imagem_base64">
            <input type="hidden" id="problema_identificado" name="problema_identificado">
            <input type="hidden" id="descricao_ai" name="descricao_ai"> 
            
            <input type="hidden" id="nome_final" name="nome_final"> 
            <input type="hidden" id="telefone_final" name="telefone_final"> 

            
            <button type="button" class="submit-btn" id="capture-restart-button">
                <span>üì∏ Capturar Imagem e Analisar Problema</span>
            </button>
            
            
            <button type="submit" class="submit-btn" id="submit-button" style="display:none; background-color: var(--success-color);">
                <span>‚úÖ Enviar para o Vereador</span>
            </button>
        </form>
        
        
        <button type="button" id="back-button" style="background: none; border: none; color: white; margin-top: 10px; font-size: 0.9rem; text-decoration: underline;">
             Voltar ao Formul√°rio
        </button>
    </div>

    <div id="success-modal" class="modal-overlay">
        <div class="modal-content">
            <p id="success-message"></p>
        </div>
    </div>

    <script>
        // ... (Todas as declara√ß√µes de constantes, let, e a l√≥gica de bloqueio de palavras) ...
        const initialFormContainer = document.getElementById('initial-form-container');
        const initialForm = document.getElementById('initial-form');
        const startCameraButton = document.getElementById('start-camera-button');
        const nomeInput = document.getElementById('nome');
        const telefoneInput = document.getElementById('telefone'); 
        const captureUI = document.getElementById('capture-ui');
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const previewImg = document.getElementById("preview-img");
        const statusText = document.getElementById('status-text');
        const captureRestartButton = document.getElementById('capture-restart-button'); 
        const backButton = document.getElementById('back-button');
        const reviewArea = document.getElementById('review-area');
        const descricaoIaReview = document.getElementById('descricao_ia_review');
        const form = document.getElementById('indication-form');
        const submitButton = document.getElementById('submit-button');
        const resultDiv = document.getElementById('form-result'); 
        const latInput = document.getElementById('latitude');
        const lonInput = document.getElementById('longitude');
        const imgBase64Input = document.getElementById('imagem_base64');
        const problemaInput = document.getElementById('problema_identificado');
        const descricaoAIInput = document.getElementById('descricao_ai');
        const nomeFinalInput = document.getElementById('nome_final');
        const telefoneFinalInput = document.getElementById('telefone_final'); 
        const streetAddressInput = document.getElementById('street_address');
        // const streetPositionInput = document.getElementById('street_position'); // Removido


        let isAnalyzing = false;
        let capturedImageBase64 = null;
        let currentLatitude = null;
        let currentLongitude = null;
        let cameraStream = null; 

        const blockedWords = [
            'inv√°lido', 'fraude', 'roubo', 'cu', 'c√∫', 'fdp', 'safado', 'bandido', 
            'denunciar', 'policia', 'pol√≠cia', 'vagabundo', 'pilantra', 'roubar', 
            'm√£e', 'den√∫ncia', 'denuncia', 'caralho', 'ladr√£o', 'corrupto', 
            'idiota', 'imbecil', 'vtmnc', 'ladr√µes', 'corrupto', 'ladrao', 'ladr√£o','foder', 'fuder','vsf','vtmnc','merda','puta','bosta','foda','porra','viado','veado','buceta','cacete','idiota','imbecil','chupa','chupar','pica','piru','pika','anus'
        ];
        const blockedWordsRegex = new RegExp(`\\b(${blockedWords.join('|')})\\b`, 'gi');

        function sanitizeInput(event) {
            const input = event.target;
            const originalValue = input.value;
            const sanitizedValue = originalValue.replace(blockedWordsRegex, ''); 

            if (originalValue !== sanitizedValue) {
                const cursorPosition = input.selectionStart - (originalValue.length - sanitizedValue.length);
                input.value = sanitizedValue;
                input.setSelectionRange(cursorPosition, cursorPosition);
            }
        }
        nomeInput.addEventListener('input', sanitizeInput);
        
        descricaoIaReview.addEventListener('input', () => {
            descricaoAIInput.value = descricaoIaReview.value;
        });

        // --- FUN√á√ïES DE C√ÇMERA (Sem altera√ß√£o) ---
        async function startCameraStream() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } });
                video.srcObject = cameraStream;
                video.style.display = 'block';
                video.play(); 
                statusText.style.display = 'none'; 
                return cameraStream;
            } catch (err) {
                statusText.textContent = 'Erro ao acessar a c√¢mera. Verifique as permiss√µes.';
                statusText.style.display = 'block';
                console.error("Erro na C√¢mera:", err);
                throw err;
            }
        }
        
        function stopCameraStream() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                video.srcObject = null; 
                video.style.display = 'none';
                previewImg.style.display = 'none';
                cameraStream = null;
            }
        }

        // --- FUN√á√ÉO DE GPS (TRAVA DE PRECIS√ÉO MAIS R√çGIDA) ---
        function getGeolocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    return resolve(null);
                }
                
                statusText.textContent = 'Buscando sinal de GPS de alta precis√£o...';
                statusText.style.display = 'block';
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // SUCESSO
                        const accuracy = position.coords.accuracy; 
                        console.log("Precis√£o do GPS obtida: " + accuracy + " metros.");

                        // --- TRAVA DE PRECIS√ÉO (150 METROS) ---
                        // Se a precis√£o for pior que 50 metros, √© lixo (provavelmente IP ou torre de celular).
                        if (accuracy > 50) { 
                            console.warn("GPS lock obtido, mas precis√£o muito baixa: " + accuracy + "m. Rejeitando.");
                            statusText.textContent = "GPS com baixa precis√£o (Erro > 50m). Tente em local aberto.";
                            statusText.style.display = 'block';
                            resolve(null); // Rejeita a posi√ß√£o
                        } else {
                            // Precis√£o aceit√°vel (GPS ou Wi-Fi)
                            statusText.style.display = 'none'; 
                            resolve(position);
                        }
                    }, 
                    (error) => {
                        // ERRO (Permiss√£o negada, Timeout, etc.)
                        let errorMessage = 'Falha no GPS. ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "GPS bloqueado. Voc√™ precisa autorizar a 'Localiza√ß√£o Precisa' no navegador.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "Sinal de GPS indispon√≠vel. Tente em um local aberto.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "Tempo limite do GPS esgotado (10s). Sinal muito fraco.";
                                break;
                        }
                        
                        statusText.textContent = errorMessage;
                        statusText.style.display = 'block';
                        resolve(null); 
                    }, 
                    { 
                        enableHighAccuracy: true, 
                        timeout: 10000, 
                        maximumAge: 0 
                    } 
                );
            });
        }
        
        // --- HANDLER: INICIAR C√ÇMERA (ETAPA 1 -> ETAPA 2) ---
        // (Sem altera√ß√µes, exceto a valida√ß√£o de telefone)
        startCameraButton.addEventListener('click', async () => {
            const nomeSanitizado = nomeInput.value.replace(blockedWordsRegex, '').trim();
            const telefone = telefoneInput.value.trim().replace(/\D/g, ''); 

            if (nomeSanitizado.length < 4) {
                 resultDiv.innerHTML = `‚ùå O campo Nome Completo deve ter no m√≠nimo 4 letras.`;
                 resultDiv.style.display = 'block';
                 return;
            }
            if (telefone.length < 8) { 
                 resultDiv.innerHTML = `‚ùå O campo Telefone/WhatsApp deve ter no m√≠nimo 8 d√≠gitos.`;
                 resultDiv.style.display = 'block';
                 return;
            }

            resultDiv.style.display = 'none'; 
            nomeInput.value = nomeSanitizado; 
            
            nomeFinalInput.value = nomeSanitizado;
            telefoneFinalInput.value = telefone;

            try {
                startCameraButton.disabled = true;
                startCameraButton.querySelector('span').textContent = 'Ativando C√¢mera...';
                
                initialFormContainer.style.display = 'none';
                captureUI.style.display = 'flex'; 
                
                await startCameraStream(); 
                
                // Tentativa 1 de GPS (em paralelo)
                getGeolocation().then(geoPosition => {
                    if (geoPosition) {
                        currentLatitude = geoPosition.coords.latitude;
                        currentLongitude = geoPosition.coords.longitude;
                        statusText.textContent = "GPS OK. Pronto para capturar.";
                        statusText.style.display = 'block';
                        setTimeout(() => statusText.style.display = 'none', 3000); 
                    }
                });
                
                resetCaptureButton();

            } catch (error) {
                initialFormContainer.style.display = 'flex'; 
                captureUI.style.display = 'none';
                resultDiv.innerHTML = `‚ùå Erro na C√¢mera: ${error.message}.`;
                resultDiv.style.display = 'block';
            } finally {
                startCameraButton.disabled = false;
                startCameraButton.querySelector('span').textContent = '‚ñ∂Ô∏è Iniciar C√¢mera e GPS';
            }
        });
        
        // --- HANDLER: VOLTAR (ETAPA 2 -> ETAPA 1) ---
        backButton.addEventListener('click', () => {
            stopCameraStream();
            captureUI.style.display = 'none';
            initialFormContainer.style.display = 'flex'; 
            
            nomeFinalInput.value = '';
            telefoneFinalInput.value = '';
            reviewArea.style.display = 'none'; 
            descricaoIaReview.value = ''; 

            submitButton.style.display = 'none';
            resetCaptureButton();
            previewImg.style.display = 'none';
            statusText.style.display = 'none';
            resultDiv.style.display = 'none'; 
        });

        // --- Fun√ß√µes de Bot√£o (Sem altera√ß√µes) ---
        function resetCaptureButton() {
            captureRestartButton.style.display = 'block';
            captureRestartButton.disabled = false;
            captureRestartButton.querySelector('span').textContent = 'üì∏ Capturar Imagem e Analisar Problema';
            captureRestartButton.removeEventListener('click', restartCamera);
            captureRestartButton.addEventListener('click', startAnalysis);
        }

        function switchToRestartButton() {
            captureRestartButton.disabled = false;
            captureRestartButton.querySelector('span').textContent = 'üîÑ Reiniciar C√¢mera';
            captureRestartButton.style.backgroundColor = 'var(--primary-hover)';
            captureRestartButton.removeEventListener('click', startAnalysis);
            captureRestartButton.addEventListener('click', restartCamera);
        }

        async function restartCamera() {
            stopCameraStream(); 
            
            statusText.style.display = 'none';
            submitButton.style.display = 'none';
            previewImg.style.display = 'none';
            reviewArea.style.display = 'none'; 
            descricaoIaReview.value = ''; 
            
            try {
                captureRestartButton.disabled = true;
                captureRestartButton.querySelector('span').textContent = 'Ativando C√¢mera...';
                await startCameraStream();
                
                getGeolocation().then(geoPosition => { 
                    if (geoPosition) {
                        currentLatitude = geoPosition.coords.latitude;
                        currentLongitude = geoPosition.coords.longitude;
                    }
                });
                resetCaptureButton(); 
            } catch (error) {
                statusText.innerHTML = `‚ùå Erro ao reiniciar c√¢mera: ${error.message}.`;
                statusText.style.display = 'block';
                switchToRestartButton(); 
            }
        }


        // --- 2. IN√çCIO DA CAPTURA (MODIFICADO) ---
        async function startAnalysis() {
            if (isAnalyzing) return;
            isAnalyzing = true;
            
            if (!nomeFinalInput.value.trim() || !telefoneFinalInput.value.trim()) {
                 statusText.innerHTML = `‚ùå Erro: Por favor, volte e preencha os campos obrigat√≥rios.`;
                 statusText.style.display = 'block';
                 isAnalyzing = false;
                 return;
            }
            
            try {
                captureRestartButton.disabled = true;
                captureRestartButton.querySelector('span').textContent = 'Preparando...';
                statusText.style.display = 'block'; 
                
                // --- VERIFICA√á√ÉO DE GPS OBRIGAT√ìRIO (COM TRAVA DE PRECIS√ÉO) ---
                if (currentLatitude === null || currentLongitude === null) {
                    statusText.textContent = 'GPS n√£o capturado. Tentando novamente (Modo Obrigat√≥rio)...';
                    const geoPosition = await getGeolocation(); 
                    
                    if (geoPosition) {
                        currentLatitude = geoPosition.coords.latitude;
                        currentLongitude = geoPosition.coords.longitude;
                    } else {
                        throw new Error(statusText.textContent || 'N√£o foi poss√≠vel obter sua localiza√ß√£o GPS. A indica√ß√£o n√£o pode ser enviada sem a localiza√ß√£o.');
                    }
                }
                // --- FIM DA VERIFICA√á√ÉO DE GPS ---

                
                // 1. Capturar Imagem
                statusText.textContent = 'Capturando imagem...';
                const MAX_WIDTH = 1024;
                const scale = MAX_WIDTH / video.videoWidth;
                canvas.width = MAX_WIDTH;
                canvas.height = video.videoHeight * scale;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                capturedImageBase64 = canvas.toDataURL('image/jpeg', 0.6); 

                // Parar a c√¢mera e exibir a pr√©-visualiza√ß√£o
                stopCameraStream();
                
                previewImg.src = capturedImageBase64;
                previewImg.style.display = 'block';
                
                // 3. Chamar a API de IA para An√°lise
                statusText.textContent = 'Analisando imagem e gerando texto...';
                captureRestartButton.querySelector('span').textContent = 'Analisando com IA...';
                
                const analysisResponse = await fetch('/api/analyze-problem', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        image: capturedImageBase64, 
                        latitude: currentLatitude, 
                        longitude: currentLongitude 
                    }),
                });
                
                const analysisResult = await analysisResponse.json();

                if (!analysisResponse.ok || analysisResult.error) {
                    throw new Error(analysisResult.error || 'Falha na an√°lise da IA.');
                }
                
                // --- VERIFICA√á√ÉO DE SEGURAN√áA E CONTE√öDO ---
                
                if (analysisResult.is_inappropriate === true) {
                    throw new Error('Conte√∫do da imagem sinalizado como impr√≥prio. O envio foi bloqueado!');
                }
                
                const problemTypeClean = analysisResult.problem_type.toLowerCase();
                if (problemTypeClean.includes("nenhum problema") || problemTypeClean.includes("n/a") || problemTypeClean.includes("n√£o detectado")) {
                    throw new Error('Nenhum problema urbano detectado. Certifique-se de que a foto foca em um problema p√∫blico (buraco na rua, poste sem luz, etc.).');
                }
                
                // 4. Preencher campos ocultos e preparar para o envio
                const sanitizedDescription = analysisResult.formal_description.replace(blockedWordsRegex, '');
                
                problemaInput.value = analysisResult.problem_type.replace(blockedWordsRegex, ''); 
                descricaoAIInput.value = sanitizedDescription; // Campo oculto
                imgBase64Input.value = capturedImageBase64; 
                streetAddressInput.value = analysisResult.street_address || '';
                // streetPositionInput.value = analysisResult.street_position || ''; // Removido


                // 5. Mudar a interface para o modo de Revis√£o/Envio
                const addressText = analysisResult.street_address ? 
                                    `${analysisResult.street_address}` : // Removida a Posi√ß√£o
                                    `Localiza√ß√£o GPS capturada.`;
                
                statusText.innerHTML = `‚úÖ **Problema:** ${problemaInput.value}. Endere√ßo: **${addressText}**. Revise o texto abaixo e clique em 'Enviar'.`;
                
                descricaoIaReview.value = sanitizedDescription; // Campo vis√≠vel
                reviewArea.style.display = 'block'; // Mostra a √°rea de revis√£o

                submitButton.style.display = 'block'; 
                switchToRestartButton(); 

            } catch (error) {
                statusText.innerHTML = `‚ùå Erro na an√°lise: ${error.message}. Clique em 'Reiniciar C√¢mera' para tentar novamente.`;
                statusText.style.display = 'block';
                submitButton.style.display = 'none'; 
                reviewArea.style.display = 'none'; 
                
                if (!capturedImageBase64) {
                    restartCamera(); 
                } else {
                    previewImg.style.display = 'block';
                }
                
                switchToRestartButton(); 
            } finally {
                isAnalyzing = false;
            }
        }


        // --- 3. SUBMISS√ÉO FINAL DO FORMUL√ÅRIO (MODIFICADO) ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            submitButton.disabled = true;
            submitButton.querySelector('span').textContent = 'Enviando e-mail...';
            
            if (!currentLatitude || !currentLongitude) {
                statusText.innerHTML = `‚ùå Erro: O envio foi bloqueado pois a localiza√ß√£o GPS √© inv√°lida.`;
                statusText.style.display = 'block';
                submitButton.disabled = false;
                submitButton.querySelector('span').textContent = '‚úÖ Enviar para o Vereador';
                return;
            }

            const enderecoGPS = `Latitude: ${currentLatitude}, Longitude: ${currentLongitude}`;
            
            const dataToSend = {
                nome: nomeFinalInput.value, 
                telefone: telefoneFinalInput.value, 
                endereco: enderecoGPS, 
                descricao: descricaoAIInput.value, 
                imagem_base64: imgBase64Input.value, 
                problema: problemaInput.value,
                street_address: streetAddressInput.value,
                // street_position: streetPositionInput.value // Removido
            };

            const backendUrl = '/api/send-email'; 

            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend),
                });
                
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Ocorreu um erro no servidor.');
                }

                document.getElementById('success-message').textContent = "Indica√ß√£o enviada com sucesso! O vereador receber√° sua solicita√ß√£o formatada pela IA.";
                document.getElementById('success-modal').style.display = 'flex';
                
                // Reinicia a interface para a Etapa 1
                initialForm.reset();
                captureUI.style.display = 'none';
                initialFormContainer.style.display = 'flex';
                
                // Limpa o estado da Etapa 2
                submitButton.style.display = 'none';
                resetCaptureButton(); 
                previewImg.style.display = 'none';
                statusText.style.display = 'none';
                reviewArea.style.display = 'none';
                descricaoIaReview.value = '';
                
                setTimeout(() => {
                    document.getElementById('success-modal').style.display = 'none';
                }, 8000);

            } catch (error) {
                statusText.innerHTML = `‚ùå Erro ao enviar: ${error.message}.`;
                statusText.style.display = 'block';
                submitButton.disabled = false;
                submitButton.querySelector('span').textContent = '‚úÖ Enviar para o Vereador';
            } finally {
                // ...
            }
        });

        // --- 4. INICIALIZA√á√ÉO ---
        captureRestartButton.addEventListener('click', startAnalysis);
        initialFormContainer.style.display = 'flex';
        
    </script>
</body>
</html>
