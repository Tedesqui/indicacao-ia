<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mande o seu Pedido - Captura Automatizada por IA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007BFF;
            --primary-hover: #0056b3;
            --background-color: #f4f7f9;
            --form-background: #ffffff;
            --text-color: #333;
            --label-color: #555;
            --border-color: #ccc;
            --success-color: #28a745;
            --error-color: #dc3545;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 2rem 1rem;
            display: flex;
            justify-content: center;
            /* MUDEI: O container vai para o final da tela */
            align-items: flex-end;
            min-height: 100vh;
        }
        /* Configura√ß√£o de C√¢mera e Canvas para cobrir a tela */
        video, canvas {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; z-index: -1;
        }
        canvas { display: none; }

        .container {
            /* MUDEI: Torna o container semi-transparente e o move para baixo */
            background-color: rgba(255, 255, 255, 0.95);
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 650px;
            box-sizing: border-box;
            transform: none; /* Removida a transla√ß√£o */
            margin-bottom: 20px;
            z-index: 10; /* Garante que fique acima da c√¢mera */
        }
        h1 {
            color: #000000;
            text-align: center;
            margin-top: 0;
            margin-bottom: calc(2rem - 10px);
            font-weight: 700;
        }
        .form-group {
            margin-bottom: 19px;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--label-color);
        }
        input[type="text"],
        textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        .submit-btn {
            background: linear-gradient(45deg, #007BFF, #0056b3);
            color: white;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .submit-btn:disabled {
            background: #aaa;
            cursor: not-allowed;
        }
        #form-result {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            display: none;
        }
        #form-result.error {
            background-color: #fdecea;
            color: var(--error-color);
            display: block;
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: var(--form-background); padding: 2.5rem 3.5rem;
            border-radius: 12px; text-align: center;
        }
        .modal-content p {
            margin: 0; font-size: 1.2rem; font-weight: 600; color: var(--success-color);
        }
        /* Estilos para a √°rea de status e preview */
        #capture-area {
            text-align: center;
        }
        #preview-img {
            border: 2px solid var(--primary-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>

    <div class="container" id="camera-container">
        <h1>Capture o Problema</h1>
        
        <div id="capture-area">
            <div id="status-text" style="font-size: 1.1rem; margin-bottom: 20px; font-weight: 600; color: var(--primary-color);">
                Aguardando acesso √† c√¢mera e localiza√ß√£o...
            </div>
            <img id="preview-img" style="max-width: 100%; max-height: 300px; border-radius: 8px; margin-bottom: 20px; display: none;" />
        </div>

        <form id="indication-form">
            <div class="form-group">
                <label for="nome">Seu Nome Completo</label>
                <input type="text" id="nome" name="nome" required>
            </div>
            
            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">
            <input type="hidden" id="imagem_base64" name="imagem_base64">
            <input type="hidden" id="problema_identificado" name="problema_identificado">
            <input type="hidden" id="descricao_ai" name="descricao_ai">
            
            <button type="button" class="submit-btn" id="start-analysis-button">
                <span>üì∏ Iniciar Captura e An√°lise</span>
            </button>
            
            <button type="submit" class="submit-btn" id="submit-button" style="display:none; background-color: var(--success-color);">
                <span>‚úÖ Enviar para Vereador</span>
            </button>
        </form>
        
        <div id="form-result"></div>
    </div>
    <div id="success-modal" class="modal-overlay">
        <div class="modal-content">
            <p id="success-message"></p>
        </div>
    </div>

    <script>
        const form = document.getElementById('indication-form');
        const resultDiv = document.getElementById('form-result');
        const startAnalysisButton = document.getElementById('start-analysis-button');
        const submitButton = document.getElementById('submit-button');
        const statusText = document.getElementById('status-text');
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const previewImg = document.getElementById("preview-img");
        
        // Campos de Input
        const nomeInput = document.getElementById('nome');
        const latInput = document.getElementById('latitude');
        const lonInput = document.getElementById('longitude');
        const imgBase64Input = document.getElementById('imagem_base64');
        const problemaInput = document.getElementById('problema_identificado');
        const descricaoAIInput = document.getElementById('descricao_ai');

        let isAnalyzing = false;
        let capturedImageBase64 = null;
        let currentLatitude = null;
        let currentLongitude = null;

        // --- L√ìGICA DE BLOQUEIO DE PALAVRAS ---
        const blockedWords = [
            'inv√°lido', 'fraude', 'roubo', 'cu', 'c√∫', 'fdp', 'safado', 'bandido', 
            'denunciar', 'policia', 'pol√≠cia', 'vagabundo', 'pilantra', 'roubar', 
            'm√£e', 'den√∫ncia', 'denuncia', 'caralho', 'ladr√£o', 'corrupto', 
            'idiota', 'imbecil', 'vtmnc', 'ladr√µes', 'corrupto', 'ladrao', 'ladr√£o','foder', 'fuder','vsf','vtmnc','merda','puta','bosta','foda','porra','viado','veado','buceta','cacete','idiota','imbecil','chupa','chupar','pica','piru','pika','anus'
        ];
        const blockedWordsRegex = new RegExp(`\\b(${blockedWords.join('|')})\\b`, 'gi');

        function sanitizeInput(event) {
            const input = event.target;
            const originalValue = input.value;
            const sanitizedValue = originalValue.replace(blockedWordsRegex, ''); 

            if (originalValue !== sanitizedValue) {
                const cursorPosition = input.selectionStart - (originalValue.length - sanitizedValue.length);
                input.value = sanitizedValue;
                input.setSelectionRange(cursorPosition, cursorPosition);
            }
        }
        
        // Aplica a sanitiza√ß√£o ao campo NOME
        nomeInput.addEventListener('input', sanitizeInput);
        // --- FIM L√ìGICA DE BLOQUEIO ---

        // --- 1. FUN√á√ïES DE C√ÇMERA E GPS ---

        function startCamera() {
            return navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } })
                .then(stream => {
                    video.srcObject = stream;
                    video.style.display = 'block';
                    statusText.textContent = 'C√¢mera pronta. Clique para capturar a imagem.';
                })
                .catch(err => {
                    statusText.textContent = 'Erro ao acessar a c√¢mera. Tente novamente.';
                    console.error("Erro na C√¢mera:", err);
                    throw err;
                });
        }

        function getGeolocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    return resolve(null);
                }
                
                // MENSAGEM DO GPS: Agora atualiza o status, mas N√ÉO bloqueia a UI
                statusText.textContent = 'Tentando obter sua localiza√ß√£o GPS...';
                
                // Define um timeout mais curto para n√£o demorar
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        statusText.textContent = 'Localiza√ß√£o GPS obtida com sucesso.';
                        resolve(position);
                    }, 
                    (error) => {
                        statusText.textContent = 'Acesso √† localiza√ß√£o negado ou falha no GPS. Usaremos apenas a foto.';
                        resolve(null); // Resolve como null para n√£o quebrar o fluxo
                    }, 
                    { enableHighAccuracy: true, timeout: 3000, maximumAge: 0 } // Reduzindo o timeout para 3s
                );
            });
        }
        
        // --- 2. IN√çCIO DA CAPTURA (Bot√£o 'Iniciar Captura e An√°lise') ---

        startAnalysisButton.addEventListener('click', async () => {
            if (isAnalyzing) return;
            isAnalyzing = true;
            
            // Revalida√ß√£o do nome
            const nomeSanitizado = nomeInput.value.replace(blockedWordsRegex, '').trim();
            if (!nomeSanitizado) {
                 resultDiv.innerHTML = `‚ùå O campo Nome √© obrigat√≥rio e n√£o pode conter palavras inadequadas.`;
                 resultDiv.style.display = 'block';
                 resultDiv.classList.add('error');
                 isAnalyzing = false;
                 return;
            }
            nomeInput.value = nomeSanitizado; // Atualiza o campo com o nome limpo
            
            resultDiv.style.display = 'none'; // Limpa mensagens de erro anteriores

            try {
                startAnalysisButton.disabled = true;
                startAnalysisButton.querySelector('span').textContent = 'Preparando...';
                
                // 1. Obter Localiza√ß√£o (Chama de novo se for nulo, mas com timeout curto)
                // Se j√° houver um valor, ele n√£o chama novamente.
                if (currentLatitude === null) {
                    const geoPosition = await getGeolocation();
                    if (geoPosition) {
                        currentLatitude = geoPosition.coords.latitude;
                        currentLongitude = geoPosition.coords.longitude;
                        latInput.value = currentLatitude;
                        lonInput.value = currentLongitude;
                    }
                }

                // 2. Capturar Imagem
                statusText.textContent = 'Capturando imagem...';
                const MAX_WIDTH = 1024;
                const scale = MAX_WIDTH / video.videoWidth;
                canvas.width = MAX_WIDTH;
                canvas.height = video.videoHeight * scale;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                capturedImageBase64 = canvas.toDataURL('image/jpeg', 0.85);

                // Parar a c√¢mera e exibir a pr√©-visualiza√ß√£o
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.style.display = 'none';
                }
                previewImg.src = capturedImageBase64;
                previewImg.style.display = 'block';

                // 3. Chamar a API de IA para An√°lise
                statusText.textContent = 'Analisando imagem e gerando texto...';
                startAnalysisButton.querySelector('span').textContent = 'Analisando com IA...';
                
                const analysisResponse = await fetch('/api/analyze-problem', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        image: capturedImageBase64, 
                        latitude: currentLatitude, 
                        longitude: currentLongitude 
                    }),
                });
                
                const analysisResult = await analysisResponse.json();

                if (!analysisResponse.ok || analysisResult.error) {
                    throw new Error(analysisResult.error || 'Falha na an√°lise da IA.');
                }
                
                // --- VERIFICA√á√ÉO DE SEGURAN√áA E CONTE√öDO ---
                
                // A. Conte√∫do Impr√≥prio
                if (analysisResult.is_inappropriate === true) {
                    throw new Error('Conte√∫do da imagem sinalizado como impr√≥prio. O envio foi bloqueado para modera√ß√£o.');
                }
                
                // B. Problema N√£o Detectado (Verifica a string retornada pela IA)
                const problemTypeClean = analysisResult.problem_type.toLowerCase();
                if (problemTypeClean.includes("nenhum problema") || problemTypeClean.includes("n/a") || problemTypeClean.includes("n√£o detectado")) {
                    throw new Error('Nenhum problema urbano detectado. Certifique-se de que a foto foca em um problema c√≠vico (buraco, lixo, poste, etc.).');
                }
                
                // 4. Preencher dados no formul√°rio (oculto)
                problemaInput.value = analysisResult.problem_type.replace(blockedWordsRegex, ''); 
                descricaoAIInput.value = analysisResult.formal_description.replace(blockedWordsRegex, ''); 
                imgBase64Input.value = capturedImageBase64; 

                // 5. Mudar a interface para o modo de Revis√£o/Envio
                const locationStatus = currentLatitude ? `Localiza√ß√£o capturada.` : `Localiza√ß√£o N√ÉO capturada.`;
                statusText.innerHTML = `‚úÖ **Problema:** ${problemaInput.value}. ${locationStatus} O texto para o vereador foi gerado. Clique em 'Enviar para Vereador'.`;
                startAnalysisButton.style.display = 'none';
                submitButton.style.display = 'block';

            } catch (error) {
                statusText.innerHTML = `‚ùå Erro na an√°lise: ${error.message}. Tente novamente.`;
                console.error('Erro na An√°lise:', error);
                
            } finally {
                isAnalyzing = false;
                startAnalysisButton.disabled = false;
                startAnalysisButton.querySelector('span').textContent = 'üì∏ Iniciar Captura e An√°lise';
                // Reinicia a c√¢mera para uma nova tentativa se o envio n√£o tiver aparecido
                if(submitButton.style.display === 'none') {
                    startCamera(); 
                }
            }
        });


        // --- 3. SUBMISS√ÉO FINAL DO FORMUL√ÅRIO (Para 'send-email') ---

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            submitButton.disabled = true;
            submitButton.querySelector('span').textContent = 'Enviando e-mail...';
            resultDiv.style.display = 'none';

            // Dados a serem enviados
            const enderecoFormatado = currentLatitude && currentLongitude ? 
                `Latitude: ${currentLatitude}, Longitude: ${currentLongitude}` : 
                'Endere√ßo n√£o capturado via GPS.';
            
            const dataToSend = {
                nome: nomeInput.value, 
                endereco: enderecoFormatado, 
                descricao: descricaoAIInput.value, 
                imagem_base64: imgBase64Input.value, 
                problema: problemaInput.value 
            };

            const backendUrl = '/api/send-email'; 

            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend),
                });
                
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Ocorreu um erro no servidor.');
                }

                document.getElementById('success-message').textContent = "Indica√ß√£o enviada com sucesso! O vereador receber√° sua solicita√ß√£o formatada pela IA.";
                document.getElementById('success-modal').style.display = 'flex';
                
                // Limpa campos e reinicia a interface
                form.reset();
                previewImg.style.display = 'none';
                submitButton.style.display = 'none';
                startAnalysisButton.style.display = 'block';
                startCamera();

                setTimeout(() => {
                    document.getElementById('success-modal').style.display = 'none';
                }, 8000);

            } catch (error) {
                resultDiv.innerHTML = `Ops! Algo deu errado ao enviar: ${error.message}`;
                resultDiv.style.display = 'block';
                resultDiv.classList.add('error');
            } finally {
                submitButton.disabled = false;
                submitButton.querySelector('span').textContent = '‚úÖ Enviar para Vereador';
            }
        });

        // --- 4. INICIALIZA√á√ÉO ---
        // Inicia a c√¢mera primeiro. Tenta obter o GPS em paralelo, sem bloqueio.
        startCamera().then(() => getGeolocation()); 
    </script>
</body>
</html>
