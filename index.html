<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mande o seu Pedido - Captura Automatizada por IA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007BFF;
            --primary-hover: #0056b3;
            --background-color: #f4f7f9;
            --form-background: #ffffff;
            --text-color: #333;
            --label-color: #555;
            --border-color: #ccc;
            --success-color: #28a745;
            --error-color: #dc3545;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow: hidden; /* Evita scroll indesejado com elementos fixed */
        }
        /* Configura√ß√£o de C√¢mera e Canvas */
        video, canvas {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; z-index: -1;
            display: none; 
        }

        /* Container Inicial Fixado no Topo */
        #initial-form-container {
            position: fixed;
            top: 20px; 
            left: 50%;
            transform: translateX(-50%); 
            background-color: var(--form-background);
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 650px;
            box-sizing: border-box;
            z-index: 10;
            display: flex; 
            flex-direction: column; 
        }
        
        /* NOVO ESTILO: Container de controle que aparecer√° DURANTE a captura
           Agora √© transparente, apenas para agrupar os bot√µes no rodap√©. */
        #capture-ui {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 1.5rem 1rem;
            background: linear-gradient(to top, rgba(0,0,0,0.4), rgba(0,0,0,0.2), transparent); /* Gradiente suave e mais transparente */
            color: white;
            text-align: center;
            z-index: 5; 
            box-sizing: border-box;
            display: none; 
            justify-content: center; /* Centraliza horizontalmente */
            align-items: flex-end; /* Alinha os itens na parte inferior do container */
            flex-direction: column; /* Para empilhar os bot√µes */
            gap: 10px; /* Espa√ßamento entre os bot√µes */
        }
        
        #capture-ui h1 { /* Removido, mas deixado por seguran√ßa */
            display: none; 
        }
        #capture-ui #status-text { /* Estilo da mensagem de status durante a captura/an√°lise */
            color: white; /* Mais vis√≠vel */
            background-color: rgba(0,0,0,0.6);
            padding: 8px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.9em;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            display: none; /* Come√ßa oculto e √© mostrado via JS */
        }

        /* Estilos do Formul√°rio (Mantidos) */
        h1 { color: #000000; text-align: center; margin-top: 0; margin-bottom: 2rem; font-weight: 700; }
        .form-group { margin-bottom: 19px; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--label-color); }
        input[type="text"] {
            width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--border-color);
            border-radius: 8px; box-sizing: border-box; font-size: 1rem;
        }
        .submit-btn {
            background: linear-gradient(45deg, var(--primary-color), var(--primary-hover));
            color: white; padding: 1rem 1.5rem; border: none; border-radius: 8px;
            cursor: pointer; width: 100%; max-width: 400px; /* Limita largura dos bot√µes na captura */
            font-size: 1.1rem; font-weight: 600;
        }
        .submit-btn:disabled { background: #aaa; cursor: not-allowed; }

        /* Estilos de mensagens de erro e modal */
        #form-result { margin-top: 1.5rem; padding: 1rem; border-radius: 8px; text-align: center; font-weight: 500; display: none; }
        #form-result.error { background-color: #fdecea; color: var(--error-color); display: block; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--form-background); padding: 2.5rem 3.5rem; border-radius: 12px; text-align: center; }
        .modal-content p { margin: 0; font-size: 1.2rem; font-weight: 600; color: var(--success-color); }

        /* Preview na Etapa 2 */
        #preview-img {
            max-width: 90%; max-height: 200px; /* Aumentado para melhor visualiza√ß√£o */
            border-radius: 8px; margin-bottom: 10px;
            border: 2px solid white; display: none; 
            margin-left: auto; margin-right: auto;
            object-fit: contain; /* Garante que a imagem inteira seja vis√≠vel */
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>

    <div class="container" id="initial-form-container">
        <h1>Capture um Problema e envie pra Prefeitura</h1>
        <form id="initial-form">
            <div class="form-group">
                <label for="nome">Seu Nome Completo</label>
                <input type="text" id="nome" name="nome" required>
            </div>
            
            <button type="button" class="submit-btn" id="start-camera-button">
                <span>‚ñ∂Ô∏è Iniciar C√¢mera e GPS</span>
            </button>
        </form>
        <div id="form-result"></div>
    </div>
    
    <div id="capture-ui">
        <img id="preview-img" alt="Pr√©-visualiza√ß√£o do problema" />

        <div id="status-text" style="display: none;"></div> <form id="indication-form">
            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">
            <input type="hidden" id="imagem_base64" name="imagem_base64">
            <input type="hidden" id="problema_identificado" name="problema_identificado">
            <input type="hidden" id="descricao_ai" name="descricao_ai">
            <input type="hidden" id="nome_final" name="nome_final"> 

            <button type="button" class="submit-btn" id="capture-restart-button" style="margin-top: 15px;">
                <span>üì∏ Capturar Imagem e Analisar Problema</span>
            </button>
            
            <button type="submit" class="submit-btn" id="submit-button" style="display:none; background-color: var(--success-color);">
                <span>‚úÖ Enviar para Vereador</span>
            </button>
        </form>
        
        <button type="button" id="back-button" style="background: none; border: none; color: white; margin-top: 10px; font-size: 0.9rem; text-decoration: underline;">
             Voltar ao Formul√°rio
        </button>
    </div>

    <div id="success-modal" class="modal-overlay">
        <div class="modal-content">
            <p id="success-message"></p>
        </div>
    </div>

    <script>
        // Elementos Etapa 1
        const initialFormContainer = document.getElementById('initial-form-container');
        const initialForm = document.getElementById('initial-form');
        const startCameraButton = document.getElementById('start-camera-button');
        const nomeInput = document.getElementById('nome');
        
        // Elementos Etapa 2 (Captura)
        const captureUI = document.getElementById('capture-ui');
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const previewImg = document.getElementById("preview-img");
        const statusText = document.getElementById('status-text');
        const captureRestartButton = document.getElementById('capture-restart-button'); // Renomeado
        const backButton = document.getElementById('back-button');
        
        // Elementos Etapa 3 (Envio)
        const form = document.getElementById('indication-form');
        const submitButton = document.getElementById('submit-button');
        const resultDiv = document.getElementById('form-result'); // Usado para mensagens de erro no form inicial
        
        // Campos Ocultos (para transfer√™ncia e envio)
        const latInput = document.getElementById('latitude');
        const lonInput = document.getElementById('longitude');
        const imgBase64Input = document.getElementById('imagem_base64');
        const problemaInput = document.getElementById('problema_identificado');
        const descricaoAIInput = document.getElementById('descricao_ai');
        const nomeFinalInput = document.getElementById('nome_final');

        let isAnalyzing = false;
        let capturedImageBase64 = null;
        let currentLatitude = null;
        let currentLongitude = null;
        let cameraStream = null; // Para manter refer√™ncia ao stream

        // --- L√ìGICA DE BLOQUEIO DE PALAVRAS ---
        const blockedWords = [
            'inv√°lido', 'fraude', 'roubo', 'cu', 'c√∫', 'fdp', 'safado', 'bandido', 
            'denunciar', 'policia', 'pol√≠cia', 'vagabundo', 'pilantra', 'roubar', 
            'm√£e', 'den√∫ncia', 'denuncia', 'caralho', 'ladr√£o', 'corrupto', 
            'idiota', 'imbecil', 'vtmnc', 'ladr√µes', 'corrupto', 'ladrao', 'ladr√£o','foder', 'fuder','vsf','vtmnc','merda','puta','bosta','foda','porra','viado','veado','buceta','cacete','idiota','imbecil','chupa','chupar','pica','piru','pika','anus'
        ];
        const blockedWordsRegex = new RegExp(`\\b(${blockedWords.join('|')})\\b`, 'gi');

        function sanitizeInput(event) {
            const input = event.target;
            const originalValue = input.value;
            const sanitizedValue = originalValue.replace(blockedWordsRegex, ''); 

            if (originalValue !== sanitizedValue) {
                const cursorPosition = input.selectionStart - (originalValue.length - sanitizedValue.length);
                input.value = sanitizedValue;
                input.setSelectionRange(cursorPosition, cursorPosition);
            }
        }
        nomeInput.addEventListener('input', sanitizeInput);
        // --- FIM L√ìGICA DE BLOQUEIO ---

        // --- FUN√á√ïES DE C√ÇMERA E GPS ---

        async function startCameraStream() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } });
                video.srcObject = cameraStream;
                video.style.display = 'block';
                video.play(); // Garante que o v√≠deo comece a tocar
                statusText.style.display = 'none'; // Esconde o status ao iniciar c√¢mera
                return cameraStream;
            } catch (err) {
                statusText.textContent = 'Erro ao acessar a c√¢mera. Verifique as permiss√µes.';
                statusText.style.display = 'block';
                console.error("Erro na C√¢mera:", err);
                throw err;
            }
        }
        
        function stopCameraStream() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                video.srcObject = null; // Limpa o srcObject
                video.style.display = 'none';
                previewImg.style.display = 'none';
                cameraStream = null;
            }
        }

        function getGeolocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    return resolve(null);
                }
                
                statusText.textContent = 'Obtendo GPS...';
                statusText.style.display = 'block';
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        statusText.style.display = 'none'; // Esconde ap√≥s obter GPS
                        resolve(position);
                    }, 
                    (error) => {
                        statusText.textContent = 'GPS falhou ou negado. Continuar sem localiza√ß√£o.';
                        statusText.style.display = 'block';
                        setTimeout(() => statusText.style.display = 'none', 3000); // Esconde ap√≥s 3s
                        resolve(null); 
                    }, 
                    { enableHighAccuracy: true, timeout: 3000, maximumAge: 0 } 
                );
            });
        }
        
        // --- HANDLER: INICIAR C√ÇMERA (ETAPA 1 -> ETAPA 2) ---

        startCameraButton.addEventListener('click', async () => {
            const nomeSanitizado = nomeInput.value.replace(blockedWordsRegex, '').trim();
            if (!nomeSanitizado) {
                 resultDiv.innerHTML = `‚ùå O campo Nome Completo √© obrigat√≥rio.`;
                 resultDiv.style.display = 'block';
                 return;
            }
            resultDiv.style.display = 'none'; // Limpa a mensagem de erro do formul√°rio inicial
            nomeInput.value = nomeSanitizado; // Atualiza o campo com o nome limpo

            try {
                startCameraButton.disabled = true;
                startCameraButton.querySelector('span').textContent = 'Ativando C√¢mera...';
                
                // 1. Oculta o formul√°rio inicial e mostra a UI de captura
                initialFormContainer.style.display = 'none';
                captureUI.style.display = 'flex'; // Usar flex para #capture-ui
                
                // 2. Inicia a c√¢mera e o GPS em paralelo
                await startCameraStream(); 
                
                const geoPosition = await getGeolocation(); 
                if (geoPosition) {
                    currentLatitude = geoPosition.coords.latitude;
                    currentLongitude = geoPosition.coords.longitude;
                }
                
                // Redefine o bot√£o para "Capturar" ao iniciar a c√¢mera
                resetCaptureButton();

            } catch (error) {
                initialFormContainer.style.display = 'flex'; // Volta para o formul√°rio
                captureUI.style.display = 'none';
                resultDiv.innerHTML = `‚ùå Erro na C√¢mera: ${error.message}.`;
                resultDiv.style.display = 'block';
            } finally {
                startCameraButton.disabled = false;
                startCameraButton.querySelector('span').textContent = '‚ñ∂Ô∏è Iniciar C√¢mera e GPS';
            }
        });
        
        // --- HANDLER: VOLTAR (ETAPA 2 -> ETAPA 1) ---
        backButton.addEventListener('click', () => {
            stopCameraStream();
            captureUI.style.display = 'none';
            initialFormContainer.style.display = 'flex'; 
            
            // Limpa o estado da an√°lise e bot√µes
            submitButton.style.display = 'none';
            resetCaptureButton();
            previewImg.style.display = 'none';
            statusText.style.display = 'none';
            resultDiv.style.display = 'none'; // Limpa a mensagem de erro geral
        });

        // Fun√ß√£o para redefinir o bot√£o de captura para seu estado original
        function resetCaptureButton() {
            captureRestartButton.style.display = 'block';
            captureRestartButton.disabled = false;
            captureRestartButton.querySelector('span').textContent = 'üì∏ Capturar Imagem e Analisar Problema';
            // Garante que o listener correto est√° ativo
            captureRestartButton.removeEventListener('click', restartCamera);
            captureRestartButton.addEventListener('click', startAnalysis);
        }

        // Fun√ß√£o para mudar o bot√£o para "Reiniciar C√¢mera"
        function switchToRestartButton() {
            captureRestartButton.disabled = false;
            captureRestartButton.querySelector('span').textContent = 'üîÑ Reiniciar C√¢mera';
            captureRestartButton.style.backgroundColor = 'var(--primary-hover)';
            // Muda o listener para a fun√ß√£o de reiniciar c√¢mera
            captureRestartButton.removeEventListener('click', startAnalysis);
            captureRestartButton.addEventListener('click', restartCamera);
        }

        // Fun√ß√£o para reiniciar a c√¢mera (quando o bot√£o "Reiniciar C√¢mera" √© clicado)
        async function restartCamera() {
            stopCameraStream(); // Para qualquer stream existente
            
            statusText.style.display = 'none';
            submitButton.style.display = 'none';
            previewImg.style.display = 'none';
            
            try {
                captureRestartButton.disabled = true;
                captureRestartButton.querySelector('span').textContent = 'Ativando C√¢mera...';
                await startCameraStream();
                const geoPosition = await getGeolocation(); 
                if (geoPosition) {
                    currentLatitude = geoPosition.coords.latitude;
                    currentLongitude = geoPosition.coords.longitude;
                }
                resetCaptureButton(); // Volta o bot√£o para "Capturar"
            } catch (error) {
                statusText.innerHTML = `‚ùå Erro ao reiniciar c√¢mera: ${error.message}.`;
                statusText.style.display = 'block';
                switchToRestartButton(); // Mant√©m o bot√£o de reiniciar se der erro
            }
        }


        // --- 2. IN√çCIO DA CAPTURA (Fun√ß√£o do Bot√£o 'Capturar Imagem e Analisar Problema') ---

        async function startAnalysis() {
            if (isAnalyzing) return;
            isAnalyzing = true;
            
            // Revalida o nome (j√° limpo na Etapa 1)
            if (!nomeInput.value.trim()) {
                 statusText.innerHTML = `‚ùå Erro: Por favor, volte e preencha o nome.`;
                 statusText.style.display = 'block';
                 isAnalyzing = false;
                 return;
            }
            
            try {
                captureRestartButton.disabled = true;
                captureRestartButton.querySelector('span').textContent = 'Preparando...';
                statusText.style.display = 'block'; // Mostra status durante o processo
                statusText.textContent = 'Capturando imagem...';
                
                // 1. Capturar Imagem
                const MAX_WIDTH = 1024;
                const scale = MAX_WIDTH / video.videoWidth;
                canvas.width = MAX_WIDTH;
                canvas.height = video.videoHeight * scale;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                capturedImageBase64 = canvas.toDataURL('image/jpeg', 0.6); 

                // Parar a c√¢mera e exibir a pr√©-visualiza√ß√£o
                stopCameraStream();
                
                previewImg.src = capturedImageBase64;
                previewImg.style.display = 'block';
                
                // 2. Tenta obter o GPS uma √∫ltima vez
                if (currentLatitude === null) {
                    const geoPosition = await getGeolocation();
                    if (geoPosition) {
                        currentLatitude = geoPosition.coords.latitude;
                        currentLongitude = geoPosition.coords.longitude;
                    }
                }

                // 3. Chamar a API de IA para An√°lise
                statusText.textContent = 'Analisando imagem e gerando texto...';
                captureRestartButton.querySelector('span').textContent = 'Analisando com IA...';
                
                const analysisResponse = await fetch('/api/analyze-problem', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        image: capturedImageBase64, 
                        latitude: currentLatitude, 
                        longitude: currentLongitude 
                    }),
                });
                
                const analysisResult = await analysisResponse.json();

                if (!analysisResponse.ok || analysisResult.error) {
                    throw new Error(analysisResult.error || 'Falha na an√°lise da IA.');
                }
                
                // --- VERIFICA√á√ÉO DE SEGURAN√áA E CONTE√öDO ---
                
                if (analysisResult.is_inappropriate === true) {
                    throw new Error('Conte√∫do da imagem sinalizado como impr√≥prio. O envio foi bloqueado!');
                }
                
                const problemTypeClean = analysisResult.problem_type.toLowerCase();
                if (problemTypeClean.includes("nenhum problema") || problemTypeClean.includes("n/a") || problemTypeClean.includes("n√£o detectado")) {
                    throw new Error('Nenhum problema urbano detectado. Certifique-se de que a foto foca em um problema urbano (buraco na rua, poste sem luz, etc.).');
                }
                
                // 4. Preencher campos ocultos e preparar para o envio
                problemaInput.value = analysisResult.problem_type.replace(blockedWordsRegex, ''); 
                descricaoAIInput.value = analysisResult.formal_description.replace(blockedWordsRegex, ''); 
                imgBase64Input.value = capturedImageBase64; 
                nomeFinalInput.value = nomeInput.value; // Transfere o nome

                // 5. Mudar a interface para o modo de Revis√£o/Envio
                const locationStatus = currentLatitude ? `Localiza√ß√£o capturada.` : `Localiza√ß√£o N√ÉO capturada.`;
                statusText.innerHTML = `‚úÖ **Problema:** ${problemaInput.value}. ${locationStatus} Texto gerado. Clique em 'Enviar' ou 'Reiniciar C√¢mera'.`;
                
                submitButton.style.display = 'block'; // Mostra o bot√£o de Enviar
                switchToRestartButton(); // Muda o bot√£o de Capturar para Reiniciar C√¢mera

            } catch (error) {
                statusText.innerHTML = `‚ùå Erro na an√°lise: ${error.message}. Clique em 'Reiniciar C√¢mera' para tentar novamente.`;
                statusText.style.display = 'block';
                submitButton.style.display = 'none'; // Esconde o bot√£o de enviar se a an√°lise falhar
                switchToRestartButton(); // D√° a op√ß√£o de reiniciar a c√¢mera
            } finally {
                isAnalyzing = false;
            }
        }


        // --- 3. SUBMISS√ÉO FINAL DO FORMUL√ÅRIO (Para 'send-email') ---

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            submitButton.disabled = true;
            submitButton.querySelector('span').textContent = 'Enviando e-mail...';
            
            const enderecoFormatado = currentLatitude && currentLongitude ? 
                `Latitude: ${currentLatitude}, Longitude: ${currentLongitude}` : 
                'Endere√ßo n√£o capturado via GPS.';
            
            const dataToSend = {
                nome: nomeFinalInput.value, 
                endereco: enderecoFormatado, 
                descricao: descricaoAIInput.value, 
                imagem_base64: imgBase64Input.value, 
                problema: problemaInput.value 
            };

            const backendUrl = '/api/send-email'; 

            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend),
                });
                
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Ocorreu um erro no servidor.');
                }

                document.getElementById('success-message').textContent = "Indica√ß√£o enviada com sucesso! A prefeitura receber√° sua solicita√ß√£o formatada pela IA.";
                document.getElementById('success-modal').style.display = 'flex';
                
                // Reinicia a interface para a Etapa 1
                initialForm.reset();
                captureUI.style.display = 'none';
                initialFormContainer.style.display = 'flex';
                
                // Limpa o estado da Etapa 2
                submitButton.style.display = 'none';
                resetCaptureButton(); // Garante que o bot√£o volte ao estado original
                previewImg.style.display = 'none';
                statusText.style.display = 'none';
                
                setTimeout(() => {
                    document.getElementById('success-modal').style.display = 'none';
                }, 8000);

            } catch (error) {
                statusText.innerHTML = `‚ùå Erro ao enviar: ${error.message}.`;
                statusText.style.display = 'block';
                // Permite tentar enviar novamente ou reiniciar
                submitButton.disabled = false;
                submitButton.querySelector('span').textContent = '‚úÖ Enviar para Vereador';
            } finally {
                // Se for um erro de envio, o bot√£o de submiss√£o pode ser reativado
                // e o bot√£o de rein√≠cio/captura permanece.
            }
        });

        // --- 4. INICIALIZA√á√ÉO ---
        // Adiciona o listener inicial ao bot√£o de captura/rein√≠cio
        captureRestartButton.addEventListener('click', startAnalysis);
        
    </script>
</body>
</html>

